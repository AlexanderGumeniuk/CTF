<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование топологии сети (Админ)</title>
    <!-- Подключение Vis.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        #topology-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            background-color: #fff;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .btn-secondary {
            display: inline-block;
            width: 200px;
            margin: 10px;
            padding: 12px;
            text-align: center;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #0056b3;
        }
        /* Стили для всплывающего окна */
        #node-info {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
        }
        #node-info h3 {
            margin-top: 0;
            color: #333;
        }
        #node-info p {
            margin: 10px 0;
            color: #666;
        }
        #node-info button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        #node-info button:hover {
            background-color: #0056b3;
        }
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .modal h3 {
            margin-top: 0;
            color: #333;
        }
        .modal input, .modal textarea, .modal select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .modal textarea {
            resize: vertical;
            height: 100px;
        }
        .modal button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .modal button:hover {
            background-color: #0056b3;
        }
        .modal button + button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Редактирование топологии сети (Админ)</h1>
        <p>Здесь вы можете добавлять, удалять и редактировать элементы топологии.</p>

        <!-- Кнопки для управления -->
        <div>
            <button class="btn-secondary" onclick="openAddNodeModal()">Добавить элемент</button>
            <button class="btn-secondary" onclick="openAddRectangleModal()">Добавить прямоугольник</button>
            <button class="btn-secondary" onclick="openAddLabelModal()">Добавить надпись</button>
            <button class="btn-secondary" onclick="startLinking()">Соединить элементы</button>
            <button class="btn-secondary" onclick="startDeletingEdges()">Удалить связь</button>
            <button class="btn-secondary" onclick="saveTopology()">Сохранить топологию</button>
        </div>

        <!-- Контейнер для топологии -->
        <div id="topology-container"></div>

        <!-- Всплывающее окно с информацией о узле -->
        <div id="node-info">
            <h3 id="node-name"></h3>
            <p id="node-description"></p>
            <h4>Тип:</h4>
            <p id="node-type"></p>
            <h4>Доменное имя:</h4>
            <p id="node-domain"></p>
            <button onclick="openEditNodeModal()">Редактировать</button>
            <button onclick="deleteNode()">Удалить элемент</button>
        </div>

        <!-- Модальное окно для добавления узла -->
        <div id="add-node-modal" class="modal">
            <h3>Добавить элемент</h3>
            <input type="text" id="node-name-input" placeholder="Название узла">
            <textarea id="node-description-input" placeholder="Описание узла"></textarea>
            <input type="text" id="node-domain-input" placeholder="Доменное имя">
            <select id="node-type-input">
                <option value="server">Сервер</option>
                <option value="workstation">АРМ</option>
                <option value="switch">Коммутатор</option>
                <option value="router">Маршрутизатор</option>
                <option value="firewall">Межсетевой экран</option>
            </select>
            <button onclick="addNode()">Добавить</button>
            <button onclick="closeAddNodeModal()">Отмена</button>
        </div>

        <!-- Модальное окно для добавления прямоугольника -->
        <div id="add-rectangle-modal" class="modal">
            <h3>Добавить прямоугольник</h3>
            <input type="text" id="rectangle-name-input" placeholder="Название прямоугольника">
            <input type="number" id="rectangle-width-input" placeholder="Ширина">
            <input type="number" id="rectangle-height-input" placeholder="Высота">
            <input type="number" id="rectangle-x-input" placeholder="Координата X">
            <input type="number" id="rectangle-y-input" placeholder="Координата Y">
            <button onclick="addRectangle()">Добавить</button>
            <button onclick="closeAddRectangleModal()">Отмена</button>
        </div>

        <!-- Модальное окно для добавления надписи -->
        <div id="add-label-modal" class="modal">
            <h3>Добавить надпись</h3>
            <input type="text" id="label-text-input" placeholder="Текст надписи">
            <input type="number" id="label-x-input" placeholder="Координата X">
            <input type="number" id="label-y-input" placeholder="Координата Y">
            <button onclick="addLabel()">Добавить</button>
            <button onclick="closeAddLabelModal()">Отмена</button>
        </div>

        <!-- Модальное окно для редактирования узла -->
        <div id="edit-node-modal" class="modal">
            <h3>Редактировать элемент</h3>
            <input type="text" id="edit-node-name-input" placeholder="Название узла">
            <textarea id="edit-node-description-input" placeholder="Описание узла"></textarea>
            <input type="text" id="edit-node-domain-input" placeholder="Доменное имя">
            <select id="edit-node-type-input">
                <option value="server">Сервер</option>
                <option value="workstation">АРМ</option>
                <option value="switch">Коммутатор</option>
                <option value="router">Маршрутизатор</option>
                <option value="firewall">Межсетевой экран</option>
            </select>
            <button onclick="updateNode()">Сохранить</button>
            <button onclick="closeEditNodeModal()">Отмена</button>
        </div>

        <!-- Форма для отправки данных на сервер -->
        <form id="topology-form" action="/admin/topology" method="POST" style="display: none;">
            <input type="hidden" id="topology-data" name="topology">
        </form>

        <!-- Кнопка для возврата -->
        <a href="{{ url_for('infrastructure') }}" class="btn-secondary">Назад</a>
    </div>

    <!-- Подключение Vis.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

    <!-- Скрипт для создания топологии -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Данные для топологии из Flask
            const topologyData = {{ topology_data | tojson | safe }};
            console.log("Данные, полученные с сервера:", topologyData);

            // Проверка данных
            if (!topologyData.nodes || !Array.isArray(topologyData.nodes)) {
                console.error("topologyData.nodes не является массивом или отсутствует");
                topologyData.nodes = [];  // Инициализируем пустым массивом
            }
            if (!topologyData.links || !Array.isArray(topologyData.links)) {
                console.error("topologyData.links не является массивом или отсутствует");
                topologyData.links = [];  // Инициализируем пустым массивом
            }
            if (!topologyData.elements || !Array.isArray(topologyData.elements)) {
                console.error("topologyData.elements не является массивом или отсутствует");
                topologyData.elements = [];  // Инициализируем пустым массивом
            }

            // Пути к изображениям для каждого типа узла
            const nodeImages = {
                server: "{{ url_for('static', filename='images/server.png') }}",
                workstation: "{{ url_for('static', filename='images/workstation.png') }}",
                switch: "{{ url_for('static', filename='images/switch.png') }}",
                router: "{{ url_for('static', filename='images/router.png') }}",
                firewall: "{{ url_for('static', filename='images/firewall.png') }}"
            };

            // Инициализация контейнера
            const container = document.getElementById("topology-container");

            // Инициализация nodes и edges
            const nodes = new vis.DataSet(
                topologyData.nodes.map(node => ({
                    id: node.id,
                    label: node.label || "Нет домена",
                    shape: "image",
                    image: nodeImages[node.type] || nodeImages.server,
                    size: 30,
                    x: node.x || 0,
                    y: node.y || 0,
                    description: node.description,
                    domain: node.domain,
                    type: node.type || "server"
                }))
            );

            const edges = new vis.DataSet(
                topologyData.links.map(link => ({
                    id: link.id,
                    from: link.source,
                    to: link.target
                }))
            );

            // Инициализация сети
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    font: {
                        size: 14,
                        color: "#ffffff",
                        face: "Arial",
                        strokeWidth: 2,
                        strokeColor: "#000000"
                    }
                },
                edges: {
                    color: "#007bff",
                    width: 2,
                    smooth: false
                },
                physics: false
            };
            const network = new vis.Network(container, data, options);

            // Отображение элементов
            updateTopologyDisplay();

            // Логика для добавления узла
            function openAddNodeModal() {
                document.getElementById("add-node-modal").style.display = "block";
            }

            function closeAddNodeModal() {
                document.getElementById("add-node-modal").style.display = "none";
            }

            function addNode() {
                const name = document.getElementById("node-name-input").value;
                const description = document.getElementById("node-description-input").value;
                const domain = document.getElementById("node-domain-input").value;
                const type = document.getElementById("node-type-input").value;

                if (!name || !domain) {
                    alert("Введите название узла и доменное имя!");
                    return;
                }

                // Генерация уникального ID
                const newId = nodes.length ? Math.max(...nodes.getIds()) + 1 : 1;

                // Добавление нового узла
                nodes.add({
                    id: newId,
                    label: domain,
                    name: name,
                    description: description,
                    domain: domain,
                    type: type,
                    shape: "image",
                    image: nodeImages[type],
                    size: 30,
                    x: 0,
                    y: 0
                });

                closeAddNodeModal();
            }

            // Логика для добавления прямоугольника
            function openAddRectangleModal() {
                document.getElementById("add-rectangle-modal").style.display = "block";
            }

            function closeAddRectangleModal() {
                document.getElementById("add-rectangle-modal").style.display = "none";
            }

            function addRectangle() {
                const name = document.getElementById("rectangle-name-input").value;
                const width = parseInt(document.getElementById("rectangle-width-input").value);
                const height = parseInt(document.getElementById("rectangle-height-input").value);
                const x = parseInt(document.getElementById("rectangle-x-input").value);
                const y = parseInt(document.getElementById("rectangle-y-input").value);

                if (!name || isNaN(width) || isNaN(height) || isNaN(x) || isNaN(y)) {
                    alert("Заполните все поля корректно!");
                    return;
                }

                const newRectangle = {
                    id: `rectangle-${Date.now()}`,
                    type: "rectangle",
                    name: name,
                    width: width,
                    height: height,
                    x: x,
                    y: y
                };

                // Добавляем прямоугольник в данные
                if (!topologyData.elements) {
                    topologyData.elements = [];
                }
                topologyData.elements.push(newRectangle);

                // Обновляем отображение
                updateTopologyDisplay();

                closeAddRectangleModal();
            }

            // Логика для добавления надписи
            function openAddLabelModal() {
                document.getElementById("add-label-modal").style.display = "block";
            }

            function closeAddLabelModal() {
                document.getElementById("add-label-modal").style.display = "none";
            }

            function addLabel() {
                const text = document.getElementById("label-text-input").value;
                const x = parseInt(document.getElementById("label-x-input").value);
                const y = parseInt(document.getElementById("label-y-input").value);

                if (!text || isNaN(x) || isNaN(y)) {
                    alert("Заполните все поля корректно!");
                    return;
                }

                const newLabel = {
                    id: `label-${Date.now()}`,
                    type: "label",
                    text: text,
                    x: x,
                    y: y
                };

                // Добавляем надпись в данные
                if (!topologyData.elements) {
                    topologyData.elements = [];
                }
                topologyData.elements.push(newLabel);

                // Обновляем отображение
                updateTopologyDisplay();

                closeAddLabelModal();
            }

            // Функция для обновления отображения топологии
            function updateTopologyDisplay() {
                // Очищаем контейнер
                container.innerHTML = "";

                // Отображаем узлы и связи
                network.setData({ nodes: nodes, edges: edges });

                // Отображаем прямоугольники и надписи
                if (topologyData.elements) {
                    topologyData.elements.forEach(element => {
                        if (element.type === "rectangle") {
                            const rect = document.createElement("div");
                            rect.style.position = "absolute";
                            rect.style.left = `${element.x}px`;
                            rect.style.top = `${element.y}px`;
                            rect.style.width = `${element.width}px`;
                            rect.style.height = `${element.height}px`;
                            rect.style.border = "2px solid black";
                            rect.style.backgroundColor = "rgba(0, 123, 255, 0.1)";
                            rect.style.zIndex = 100;
                            container.appendChild(rect);
                        } else if (element.type === "label") {
                            const label = document.createElement("div");
                            label.style.position = "absolute";
                            label.style.left = `${element.x}px`;
                            label.style.top = `${element.y}px`;
                            label.style.color = "black";
                            label.style.fontSize = "14px";
                            label.style.zIndex = 100;
                            label.textContent = element.text;
                            container.appendChild(label);
                        }
                    });
                }
            }

            // Логика для сохранения топологии
            function saveTopology() {
                const updatedTopology = {
                    nodes: nodes.get().map(node => ({
                        id: node.id,
                        label: node.domain,
                        name: node.name,
                        x: node.x,
                        y: node.y,
                        description: node.description,
                        domain: node.domain,
                        type: node.type,
                        size: node.size
                    })),
                    links: edges.get().map(edge => ({ id: edge.id, source: edge.from, target: edge.to })),
                    elements: topologyData.elements || []
                };

                console.log("Данные для сохранения:", updatedTopology);

                // Заполняем скрытое поле формы
                document.getElementById("topology-data").value = JSON.stringify(updatedTopology);

                // Отправляем форму
                document.getElementById("topology-form").submit();
            }
        });
    </script>
</body>
</html>
